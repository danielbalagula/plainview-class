function notify(a,b,c){$.notify({message:b,icon:c},{allow_dismiss:!1,position:"absolute",element:"#interface",type:a,placement:{from:"bottom",align:"left"},animate:{enter:"animated fadeInUp",exit:"animated fadeOutDown"},delay:2e3,timer:1e3})}function fetchResponses(a){$.ajax({type:"GET",url:"../../api/responses",data:a,success:function(a){fetchedResponses=a.responses,loadResponseBrowser()}})}function loadResponseBrowser(){$("#responses").html(responseBrowser({responses:fetchedResponses}))}var g,svg,inner,zoom,currentDiscussionId,currentResponse,fetchedResponses=[],responseColors={subordinate:"#4286f4",concur:"#7af442",dissent:"#1d00ff",requestForClarification:"#d8d147",rejectPreviousArgumentType:"#ef0000",requestForFactualSubstantiation:"#848484"},argumentsToRespondTo=[],responses,discussion;$(document).ready(function(){function j(a,b){"samplediscussion"!==a?d3.json("../../api/discussions/id/"+a,function(a){responses=a.responses,discussion=a.discussion,b(responses,discussion)}):d3.json("../discussions/samplediscussion",function(a){responses=a.responses,discussion=a.discussion,b(responses,discussion)})}function k(g,h){function j(){d.graph().transition=function(a){return a.transition().duration(500)},d.nodes().forEach(function(b){var c=b.substring(1);void 0!==$("#t"+c).val()&&""!==$("#t"+c).val()&&(i[c].dataPersistence.writtenTitle=$("#t"+c).val()),void 0!==$("#r"+c).val()&&""!==$("#r"+c).val()&&(i[c].dataPersistence.writtenReply=$("#r"+c).val())});for(var b in i)if(i.hasOwnProperty(b)&&void 0!==d.node("n"+b)){var c;c=d.node("n"+b).label.indexOf("display:none")!==-1?"none":"inline-block";var k=$.grep(g,function(a){return a._id==b})[0];h.citations.indexOf(k._id)!==-1?d.setNode("n"+b,{style:"stroke: #9d41f4; stroke-width: 0.5px",id:"n"+b,labelType:"html",label:compiledResponseTemplate({templateData:{citationMessage:"Citation: ",displayed:c,dataPersistence:i[b].dataPersistence,response:k,class:"originalResponse",responseTypeColor:"black"}}),class:"unselected-node"}):d.setNode("n"+b,{style:"stroke: #3563ad; stroke-width: 0.5px",id:"n"+b,labelType:"html",label:compiledResponseTemplate({templateData:{displayed:c,dataPersistence:i[b].dataPersistence,response:k,class:"originalResponse",responseTypeColor:"black"}}),class:"unselected-node"})}if(d.nodes().forEach(function(a){var b=d.node(a);b.rx=b.ry=3}),d3.select("svg g").call(e,d),a){var n=$("#"+a).val();$("#"+a).val("").val(n).focus()}f.selectAll(".node").on("mousedown",function(){mouseMovement&&(textSelected=!0,mouseMovement=!1),d3.event.stopPropagation()}),f.selectAll(".node").on("mousemove",function(){mouseMovement=!0}),f.selectAll(".node").on("click",function(a){currentResponse=a}),f.selectAll(".submit-reply-button").on("click",function(a){var b=d3.select(this.parentNode.parentNode).attr("id"),c=b.substring(b.indexOf("-")+1,b.length);$.grep(g,function(a){return a._id==c})[0];if($("#t"+c).val().length<5)notify("warning","Titles should be at least 5 characters","glyphicon glyphicon-alert");else if($("#r"+c).val().length<30)notify("warning","Replies should be at least 30 characters","glyphicon glyphicon-alert");else{var e={};$.each($("#"+b).serializeArray(),function(a,b){e[b.name]=b.value}),m(e,c,!1,function(a){a&&(l("n"+c),j(),$("#r"+c).val(""),$("#t"+c).val(""),i[c].dataPersistence={writtenTitle:"",writtenReply:""})})}}),f.selectAll(".reply-button").on("click",function(a){var b="n"+d3.select(this.parentNode).attr("id");l(b),j()})}function k(a,b,c){i[a._id]="",g.push(a),i[a._id]={dataPersistence:{writtenTitle:"",writtenReply:""}},"originalResponse"===c?d.setNode("n"+a._id,{style:"stroke: #8a95a8; stroke-width: 0.5px",id:"n"+a._id,labelType:"html",label:compiledResponseTemplate({templateData:{displayed:"none",dataPersistence:i[a._id].dataPersistence,response:a,class:"originalResponse",responseTypeColor:"black"}}),class:"unselected-node"}):d.setNode("n"+a._id,{style:"stroke: #f44141; stroke-width: 0.5px",id:"n"+a._id,labelType:"html",label:compiledResponseTemplate({templateData:{displayed:"none",dataPersistence:i[a._id].dataPersistence,response:a,class:"originalResponse",responseTypeColor:"black"}}),class:"unselected-node"}),d.setEdge("n"+b,"n"+a._id,{style:"fill: none;stroke: #0084ff; stroke-width: 0.5px;",arrowhead:"undirected"}),j(),$("#r"+currentResponse).focus()}function l(a){d.node(a).label.indexOf("display:none")!==-1?d.node(a).label=d.node(a).label.replace("display:none","display:inline-block"):d.node(a).label=d.node(a).label.replace("display:inline-block","display:none")}function m(a,c,d,e){return Math.floor((Date.now()-localStorage.getItem("last_post"))/1e3)<=30&&null!==localStorage.getItem("last_post")?(notify("warning","Please wait 30 seconds after your last post","glyphicon glyphicon-alert"),void(e&&e(!1))):void(d?$.ajax({type:"POST",url:"../addCitationToDiscussion",data:{discussionId:b,citation:JSON.stringify(a),relatedResponse:c,relationshipType:"dissent"},success:function(){notify("success","Replied to conversation","glyphicon glyphicon-ok-circle"),localStorage.setItem("last_post",Date.now()),e&&e(!0)},error:function(a){400===a.status?notify("warning","You must be signed in to reply to this conversation","glyphicon glyphicon-alert"):429===a.status?notify("warning","Please wait 30 seconds after your last post","glyphicon glyphicon-alert"):notify("warning","Reply didn't go through. Please try again later","glyphicon glyphicon-alert"),e&&e(!1)}}):$.ajax({type:"POST",url:"../../responses",data:{discussionId:b,responseTitle:a.title,responseText:a.text,created_by:"Striped Rhino",relatedResponse:c,relationshipType:"dissent"},success:function(a){notify("success","Replied to conversation","glyphicon glyphicon-ok-circle"),localStorage.setItem("last_post",Date.now()),e&&e(!0)},error:function(a){400===a.status?notify("warning","You must be signed in to reply to this conversation","glyphicon glyphicon-alert"):429===a.status?notify("warning","Please wait 30 seconds after your last post","glyphicon glyphicon-alert"):notify("warning","Reply didn't go through. Please try again later","glyphicon glyphicon-alert"),e&&e(!1)}}))}var i={};g.forEach(function(a){i[a._id]={dataPersistence:{writtenTitle:"",writtenReply:""}};h.relationships.filter(function(b){return void 0!==b[a._id]})[0][a._id].relationshipType;h.citations.indexOf(a._id)!==-1?d.setNode("n"+a._id,{style:"stroke: #f44141; stroke-width: 0.5px",id:"n"+a._id,labelType:"html",label:compiledResponseTemplate({templateData:{displayed:"none",dataPersistence:i[a._id].dataPersistence,response:a,class:"citationResponse",responseTypeColor:"black"}}),class:"unselected-node "}):d.setNode("n"+a._id,{style:"stroke: #4286f4; stroke-width: 0.5px",id:"n"+a._id,labelType:"html",label:compiledResponseTemplate({templateData:{displayed:"none",dataPersistence:i[a._id].dataPersistence,response:a,class:"originalResponse",responseTypeColor:"black"}}),class:"unselected-node"}),h.relationships.slice(1,h.relationships.length).forEach(function(b){b.hasOwnProperty(a._id)&&d.setEdge("n"+b[a._id].relatedResponse,"n"+a._id,{style:"fill: none;stroke: #0084ff; stroke-width: 0.5px;",arrowhead:"undirected"})})}),c.on("newOriginalResponse",function(a){k(a.newResponse,a.relatedResponse,"originalResponse")}),c.on("newCitationResponse",function(a){k(a.citation,a.relatedResponse,"citationResponse")}),$("#responses").on("click",".cite-response",function(a){var b=$(a.target).closest("a").attr("id"),c=$.grep(fetchedResponses,function(a){return a._id==b})[0];"n"+b!==currentResponse?(m(c,currentResponse.substring(1),!0),$("#responseModal").modal("hide")):1!==$(".alert","#"+b).length&&$(a.target).closest(".thumbnail").append("<div class='alert alert-warning'>Can't cite a response to itself</div>"),l(currentResponse)}),$("#responseBrowserSearchButton").on("click",function(a){a.preventDefault();var b={title:$("#responseTitle").val(),text:$("#responseKeywords").val()};fetchResponses(b)}),$("#responses").on("click",".use-title",function(a){return}),j(d),j(d)}var a;document.addEventListener("focus",function(b){a=b.target.id},!0);var b=$(".discussionId").attr("id"),c=io();c.emit("viewingDiscussion",b);var d=(new dagreD3.graphlib.Graph).setGraph({}).setDefaultEdgeLabel(function(){return{}}),e=new dagreD3.render,f=d3.select("svg"),g=d3.select("svg g"),h=d3.behavior.zoom().on("zoom",function(){g.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")});h.scale(1.5*h.scale()),f.call(h).on("dblclick.zoom",null),f.call(h).on("dblclick.zoom",null),f.call(h).call(h.event),fetchResponses(),j(b,k),startBloodhound();var i=new Clipboard(".urlButton");i.on("success",function(a){notify("info","Copied response id to clipboard!","glyphicon glyphicon-link")})});var mouseMovement;